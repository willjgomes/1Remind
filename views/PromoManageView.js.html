
const promomanageview = {
  name: 'PromoManageView',

  components: {
    cpromocards
  },

  setup() {
    function createTabViewModel(){
      return {
        promos:  {
          active: {id:'',events:[]},
          prior:  {id:'',events:[]}
        },
        loaded: false
      }
    }

    const tab = ref('current');
    const tabName = {
      current: '',
      next: ''
    }

    const promos = reactive(createTabViewModel());
    const panel = ref([0]);
    const sortAsc = ref(true);

    const alphaicon = ref('mdi-sort-alphabetical-ascending');
    const dateicon = ref('mdi-sort-clock-ascending-outline');
    const numicon = ref('mdi-sort-numeric-ascending');

    const cardOptions = reactive({
      showDetails: true,
      sortKey: 'title'
    })

    function sortItems() {
      sortAsc.value = !sortAsc.value;
      if (cardOptions.sortKey === 'date'){
        dateicon.value = 'mdi-sort-clock-' + (sortAsc.value ? 'ascending':'descending') + '-outline';
      } else if (cardOptions.sortKey === 'title'){
        alphaicon.value = 'mdi-sort-alphabetical-' + (sortAsc.value ? 'ascending':'descending');
      }  else if (cardOptions.sortKey === 'value'){
        numicon.value = 'mdi-sort-alphabetical-' + (sortAsc.value ? 'ascending':'descending');
      }

      promos.promos.events.sort(compare);
    }

    function compare(a, b) {
      if (cardOptions.sortKey == 'title' && sortAsc.value){
        if (b.companyName > a.companyName) return -1;
        if (a.companyName > b.companyName) return 1;
      } else if (cardOptions.sortKey == 'title' && !sortAsc.value){
        if (a.companyName > b.companyName) return -1;
        if (b.companyName > a.companyName) return 1;
      } else if (cardOptions.sortKey == 'date'){
        const date1 = (new Date(a.endTime)).getTime();
        const date2 = (new Date(b.endTime)).getTime()
        if (sortAsc.value){
          if (date2 > date1) return -1;
          if (date1 > date2) return 1;
        } else {
          if (date1 > date2) return -1;
          if (date2 > date1) return 1;
        }                       
      } else if (cardOptions.sortKey == 'value' && sortAsc.value){
        if (b.offerValue > a.offerValue) return -1;
        if (a.offerValue > b.offerValue) return 1;
      } else if (cardOptions.sortKey == 'value' && !sortAsc.value){
        if (a.offerValue > b.offerValue) return -1;
        if (b.offerValue > a.offerValue) return 1;
      }
      return 0;
    }

    async function getEvents() {
      console.log("Fetching all active and inactive promotions");        
      google.script.run.withSuccessHandler(
          (data) => {
            promos.active=data;
            promos.active.events.sort(compare);
            promos.loaded = true;
            }
        ).getActivePromoEventsModel();
      google.script.run.withSuccessHandler(
        (data) => {
          promos.prior=data;
          promos.prior.events.sort(compare);
          promos.loaded = true;
          }
      ).getPriorPromoEventsModel();
    }

    function refresh(){
      promos.loaded = false;
      getEvents();
    }

    //TODO: Find Better Way to handle this
    //FIXME: Now that the prior promos tab added, this needs to delete from the proper list
    watch(lastAction, (currentValue, oldValue) => {
      console.log('Last Action: [' + currentValue + '][' + lastActionModel.value +']')
      if (['promodeleted'].includes(currentValue)){
        promos.promos.events.splice(lastActionModel.value,1);
        lastAction.value = '';
        lastActionModel.value = '';        
      } 
    })

    onMounted(() => {
      getEvents();
    })

    return {
      tab,
      tabName,
      promos,
      panel,
      cardOptions,
      alphaicon,
      dateicon,
      numicon,
      sortItems,      
      refresh
    }
  },

  template: /*html*/ `
    <v-tabs
      v-model="tab" 
      align-tabs="title"
      bg-color="cyan-darken-3"
      center-active
      slider-size="10" 
    >
      <v-tab
        key="active"
        text="Active"
        value="active"
      ></v-tab>
      <v-tab
        key="prior"
        text="Prior"
        value="prior"
      ></v-tab>
    </v-tabs>
    
    <v-btn-toggle
      v-model="cardOptions.sortKey"
      color="primary"
      mandatory
    >
      <v-btn :icon="alphaicon" value="title" @click="sortItems()"></v-btn>
      <v-btn :icon="dateicon" value="date" @click="sortItems()"></v-btn>
      <v-btn :icon="numicon" value="value" @click="sortItems()"></v-btn>
    </v-btn-toggle>

    <v-tabs-window v-model="tab">
      <v-tabs-window-item key="active" value="active">
        <v-container v-if="!promos.loaded" class="pa-2">
          <v-progress-circular indeterminate></v-progress-circular>          
        </v-container>
        <v-container v-else class="pa-2">
          <cpromocards v-model="promos.active" :options="cardOptions"></cpromocards>
        </v-container>
      </v-tabs-window-item>
      <v-tabs-window-item key="prior" value="prior">
        <v-container class="pa-2">
          <cpromocards v-model="promos.prior" :options="cardOptions"></cpromocards>
        </v-container>
      </v-tabs-window-item>
    </v-tabs-window> 
   `
}


